<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ®µè€ƒçœ‹æ¿ç³»çµ±</title>
    <style>
        :root {
            --bg-color: #000000;
            --text-color: #ffffff;
            --section-border: 4px solid #ffffff;
            --progress-green: #4caf50;
            --progress-blue: #2196F3;
            --progress-yellow: #ffeb3b;
            --progress-red: #f44336;
            --active-bg: #333333;
            --input-bg: #1a1a1a;
            --input-border: #666;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: "Microsoft JhengHei", sans-serif; }
        body, html { height: 100%; width: 100%; overflow: hidden; background-color: var(--bg-color); color: var(--text-color);}

        .container { display: flex; flex-direction: column; height: 100vh; }

        /* å·¦ä¸Šè§’è¿”å›æŒ‰éˆ• */
        .toolbox-btn {
            position: fixed;
            top: 15px;
            left: 15px;
            z-index: 3000;
            background-color: rgba(60, 60, 60, 0.8);
            color: #fff;
            padding: 8px 15px;
            border-radius: 5px;
            text-decoration: none;
            font-size: 1rem;
            border: 1px solid #777;
            transition: background-color 0.3s;
        }
        .toolbox-btn:hover {
            background-color: #555;
            border-color: #999;
        }

        /* ä¸Šæ–¹ C å€ */
        #section-c {
            height: 33.33vh;
            border-bottom: var(--section-border);
            display: flex;
            align-items: center;
            padding: 0 2rem;
            position: relative;
        }

        /* ä¸‹æ–¹ Aã€B å€ */
        .bottom-container {
            height: 66.67vh;
            display: flex;
            width: 100%;
        }

        /* æ¯”ä¾‹èª¿æ•´ 6:4 */
        #section-a {
            width: 60%;
            height: 100%;
            display: flex;
            flex-direction: column;
            position: relative;
            border-right: var(--section-border);
        }

        #section-b {
            width: 40%;
            height: 100%;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        /* C å€å…§å®¹ */
        .clock-area {
            width: 40%;
            font-size: 8vw;
            font-weight: bold;
            text-align: center;
            line-height: 1;
            color: var(--text-color);
        }

        .progress-area {
            width: 60%;
            padding-left: 4rem;
            padding-right: 2rem;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .progress-bar-bg {
            width: 100%;
            height: 5vh;
            background-color: #333;
            border-radius: 2.5vh;
            overflow: hidden;
            border: 2px solid #fff;
        }

        .progress-bar-fill {
            height: 100%;
            width: 0%;
            background-color: var(--progress-green);
            transition: width 1s linear, background-color 0.5s;
        }

        .progress-text {
            font-size: 2.5vw;
            margin-top: 15px;
            font-weight: bold;
            color: #ddd;
            line-height: 1.2;
        }

        .extend-btn {
            margin-left: 20px;
            padding: 5px 20px;
            font-size: 1.5rem;
            cursor: pointer;
            background-color: #2196F3;
            color: white;
            border: none;
            border-radius: 5px;
        }

        /* A å€å…§å®¹ */
        .schedule-container {
            flex: 2;
            display: flex;
            flex-direction: column;
            border-bottom: 2px dashed #666;
            padding: 0.5rem;
            justify-content: space-evenly;
            overflow: hidden;
        }

        .schedule-row {
            display: flex;
            align-items: center;
            padding: 5px 10px;
            border-radius: 10px;
            transition: background-color 0.3s;
            width: 100%;
            overflow: hidden;
        }
        
        .schedule-row.active {
            background-color: var(--active-bg);
            border: 2px solid #2196F3;
        }

        .auto-fit {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .schedule-row select {
            font-size: 3vw;
            padding: 5px;
            border: 1px solid var(--input-border);
            border-radius: 5px;
            margin-right: 15px;
            font-weight: bold;
            background: var(--input-bg);
            color: white;
            cursor: pointer;
            width: 50%;
            min-width: 0;
        }

        .schedule-time {
            font-size: 2.5vw;
            color: #aaa;
            font-weight: bold;
            width: 50%;
            text-align: right;
            min-width: 0;
        }

        /* Aå€ä¸‹æ–¹å‡ºå¸­çµ±è¨ˆ (é‚„åŸè‡³ V11 æ¨£å¼) */
        .attendance-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            padding: 1rem 2rem;
            background-color: #111;
            overflow: hidden;
        }

        .attendance-row {
            display: flex;
            justify-content: flex-start;
            align-items: center;
            margin-bottom: 5px;
            width: 100%;
            gap: 2rem;
        }

        .att-input-group {
            display: flex;
            align-items: center;
            font-size: 3.5vw;
            font-weight: bold;
            color: var(--text-color);
            white-space: nowrap;
        }

        .att-input-group.full-width {
            width: 100%;
        }

        .att-input-group input {
            font-size: 3.5vw;
            width: 2.5em;
            text-align: center;
            margin: 0 5px;
            border: none;
            border-bottom: 2px solid #fff;
            background: transparent;
            color: #ff5252;
            font-weight: bold;
        }

        .btn-adj {
            background: #333;
            border: 1px solid #fff;
            color: white;
            width: 4vh;
            height: 4vh;
            border-radius: 50%;
            font-size: 2vh;
            line-height: 1;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            user-select: none;
            flex-shrink: 0;
        }
        .btn-adj:active { background: #666; }
        .btn-adj:hover { background: #555; border-color: #2196F3; }

        .att-input-group input.long-text {
            width: 100%;
            text-align: left;
            color: #ffeb3b;
            flex: 1;
            min-width: 0;
        }

        /* B å€å…§å®¹ */
        #section-b {
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 2rem;
        }

        .reminder-text {
            font-size: 4vw;
            font-weight: bold;
            color: #64b5f6;
            white-space: pre-line;
        }

        .settings-btn {
            position: absolute;
            bottom: 10px;
            right: 10px;
            font-size: 2rem;
            cursor: pointer;
            background: none;
            border: none;
            opacity: 0.5;
            filter: invert(1);
        }
        .settings-btn:hover { opacity: 1; }

        /* è¨­å®šè¦–çª— (Modal) */
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.1);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background: #222;
            color: white;
            padding: 2rem;
            border-radius: 10px;
            width: 60%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 4px 15px rgba(0,0,0,0.8);
            text-align: left;
            border: 1px solid #444;
        }
        .modal h2, .modal h3 { margin-bottom: 1rem; border-bottom: 1px solid #444; padding-bottom: 10px; color: #ffeb3b;}
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; color: #ccc;}
        .form-group textarea, .form-group input[type="time"] {
            padding: 10px; font-size: 1.2rem;
            background: #111; color: white; border: 1px solid #555; border-radius: 5px;
        }
        .form-group textarea { width: 100%; }
        
        .time-setting-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        .time-setting-row label {
            width: 80px;
            margin-bottom: 0;
            color: white;
        }

        .btn-save {
            background: #4caf50; color: white; padding: 10px 30px;
            border: none; border-radius: 5px; font-size: 1.2rem; cursor: pointer; width: 100%; margin-top: 10px;
        }
        
        .status-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            color: white;
            font-size: 1.5rem;
            margin-bottom: 10px;
        }
        .status-exam { background-color: var(--progress-red); }
        .status-break { background-color: var(--progress-green); }

        /* é–‹å ´æç¤º */
        .startup-toast {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #333;
            color: white;
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            z-index: 2000;
            box-shadow: 0 10px 30px rgba(0,0,0,0.9);
            border: 6px solid #fff;
            display: none;
            width: 70%;
            max-width: 800px;
        }
        .startup-toast h2 { font-size: 3.5rem; margin-bottom: 25px; color: #ffeb3b; line-height: 1.2; }
        .startup-toast p { font-size: 2.5rem; margin-bottom: 30px; line-height: 1.4; }
        .startup-toast button {
            background: white; color: black; font-size: 2rem; padding: 15px 50px; border: none; border-radius: 50px; cursor: pointer; font-weight: bold;
        }

    </style>
</head>
<body>

    <!-- æ‡¸æµ®æŒ‰éˆ• -->
    <a href="index.html" class="toolbox-btn">è¿”å›å·¥å…·ç®±</a>

    <!-- é–‹å ´æç¤º -->
    <div id="startupToast" class="startup-toast">
        <h2>ğŸ”” è€å¸«è«‹æ³¨æ„</h2>
        <p>è«‹è¨­å®š <b>å·¦å´ç§‘ç›®</b> èˆ‡ <b>ä¸‹æ–¹äººæ•¸</b></p>
        <p>ä¸¦æª¢æŸ¥ <b>æœªåˆ°åå–®</b></p>
        <p style="color: #64b5f6; margin-top: 20px;"><b>å³ä¸‹è§’è¨­å®šå¯ä»¥èª¿æ•´æ™‚é–“åŠæé†’äº‹é …</b></p>
        <button onclick="closeStartupToast()">æˆ‘çŸ¥é“äº†</button>
    </div>

    <!-- è¨­å®šè¦–çª— -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <h2>âš™ï¸ ç³»çµ±è¨­å®š</h2>
            
            <h3>1. è€ƒè©¦æ™‚é–“è¨­å®š</h3>
            <div id="timeSettingsBlock">
                <!-- ç”± JS ç”Ÿæˆ -->
            </div>

            <h3>2. è¼ªæ’­æé†’æ–‡å­— (ä¸€è¡Œä¸€å¥)</h3>
            <div class="form-group">
                <label>è€ƒè©¦ä¸­æé†’ (æ¯5åˆ†é˜)</label>
                <textarea id="inputExamMsgs" rows="4"></textarea>
            </div>
            <div class="form-group">
                <label>ä¸‹èª²/æº–å‚™ä¸­æé†’ (æ¯2åˆ†é˜)</label>
                <textarea id="inputBreakMsgs" rows="4"></textarea>
            </div>
            
            <button class="btn-save" onclick="saveSettings()">å„²å­˜è¨­å®šä¸¦å¥—ç”¨</button>
        </div>
    </div>

    <div class="container">
        <!-- Cå€ -->
        <div id="section-c">
            <div class="clock-area" id="clockDisplay">00:00:00</div>
            <div class="progress-area">
                <div style="display: flex; align-items: center; justify-content: space-between;">
                    <span id="statusBadge" class="status-badge status-break">æº–å‚™ä¸­</span>
                    <button class="extend-btn" id="extendBtn" style="display:none;" onclick="extendTime()">å»¶é•· 5 åˆ†é˜</button>
                </div>
                <div class="progress-bar-bg">
                    <div class="progress-bar-fill" id="progressBar"></div>
                </div>
                <div class="progress-text auto-fit" id="progressText">éè€ƒè©¦æ™‚æ®µ</div>
            </div>
        </div>

        <div class="bottom-container">
            <!-- Aå€ -->
            <div id="section-a">
                <div class="schedule-container">
                    <!-- ç¬¬ä¸€ç¯€ -->
                    <div class="schedule-row">
                        <select onchange="saveInputs()" id="subj-0" class="auto-fit">
                            <option value="æœªè¨­å®š">è«‹é¸æ“‡</option>
                            <option value="åœ‹èª">åœ‹èª</option>
                            <option value="æ•¸å­¸">æ•¸å­¸</option>
                            <option value="è‹±æ–‡">è‹±æ–‡</option>
                            <option value="è‡ªç„¶">è‡ªç„¶</option>
                            <option value="ç¤¾æœƒ">ç¤¾æœƒ</option>
                            <option value="å¥åº·">å¥åº·</option>
                            <option value="è‡ªä¿®">è‡ªä¿®</option>
                        </select>
                        <div class="schedule-time auto-fit" id="time-display-0">08:00 ~ 08:50</div>
                    </div>
                    <!-- ç¬¬äºŒç¯€ -->
                    <div class="schedule-row">
                        <select onchange="saveInputs()" id="subj-1" class="auto-fit">
                            <option value="æœªè¨­å®š">è«‹é¸æ“‡</option>
                            <option value="åœ‹èª">åœ‹èª</option>
                            <option value="æ•¸å­¸">æ•¸å­¸</option>
                            <option value="è‹±æ–‡">è‹±æ–‡</option>
                            <option value="è‡ªç„¶">è‡ªç„¶</option>
                            <option value="ç¤¾æœƒ">ç¤¾æœƒ</option>
                            <option value="å¥åº·">å¥åº·</option>
                            <option value="è‡ªä¿®">è‡ªä¿®</option>
                        </select>
                        <div class="schedule-time auto-fit" id="time-display-1">09:00 ~ 09:40</div>
                    </div>
                    <!-- ç¬¬ä¸‰ç¯€ -->
                    <div class="schedule-row">
                        <select onchange="saveInputs()" id="subj-2" class="auto-fit">
                            <option value="æœªè¨­å®š">è«‹é¸æ“‡</option>
                            <option value="åœ‹èª">åœ‹èª</option>
                            <option value="æ•¸å­¸">æ•¸å­¸</option>
                            <option value="è‹±æ–‡">è‹±æ–‡</option>
                            <option value="è‡ªç„¶">è‡ªç„¶</option>
                            <option value="ç¤¾æœƒ">ç¤¾æœƒ</option>
                            <option value="å¥åº·">å¥åº·</option>
                            <option value="è‡ªä¿®">è‡ªä¿®</option>
                        </select>
                        <div class="schedule-time auto-fit" id="time-display-2">09:50 ~ 10:30</div>
                    </div>
                </div>

                <!-- Aå€ä¸‹æ–¹ï¼šå‡ºå¸­çµ±è¨ˆ (é‚„åŸè‡³ä¸Šä¸€ç‰ˆ) -->
                <div class="attendance-container">
                    <div class="attendance-row">
                        <div class="att-input-group">
                            æ‡‰åˆ°ï¼š
                            <button class="btn-adj" onclick="adjustCount('inputExpected', -1)">-</button>
                            <input type="number" id="inputExpected" value="42" onchange="saveInputs()" class="auto-fit">
                            <button class="btn-adj" onclick="adjustCount('inputExpected', 1)">+</button>
                        </div>
                        <div class="att-input-group">
                            å¯¦åˆ°ï¼š
                            <button class="btn-adj" onclick="adjustCount('inputActual', -1)">-</button>
                            <input type="number" id="inputActual" value="42" onchange="saveInputs()" class="auto-fit">
                            <button class="btn-adj" onclick="adjustCount('inputActual', 1)">+</button>
                        </div>
                    </div>
                    <div class="attendance-row">
                        <div class="att-input-group full-width">
                            æœªåˆ°ï¼š<input type="text" class="long-text auto-fit" id="inputAbsent" placeholder="ç„¡" onchange="saveInputs()">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Bå€ -->
            <div id="section-b">
                <div class="reminder-text" id="reminderDisplay">æº–å‚™è€ƒè©¦...</div>
                <button class="settings-btn" onclick="openSettings()">âš™ï¸ è¨­å®š</button>
            </div>
        </div>
    </div>

    <script>
        const defaultExamMsgs = [
            "è€ƒå·è¨˜å¾—å¯«ä¸Šç­ç´šå§“ååº§è™Ÿ",
            "æœ‰å•é¡Œèˆ‰æ‰‹å•è€å¸«ï¼Œéœ€è¦æ’¿æ±è¥¿è«‹ç›£è€ƒè€å¸«å¹«å¿™",
            "ä¸æœƒå¯«çš„é¡Œç›®è·³éå¯«æœƒçš„é¡Œç›®",
            "è€å¿ƒã€ç´°å¿ƒã€å°å¿ƒ",
            "è€ƒå·æœ‰ä¸æœƒçš„å•é¡Œç­‰å‡ºé¡Œè€å¸«ä¾†äº†å†å•",
            "ä¸è¦è½‰é ­ç©æ±è¥¿ï¼Œå¯«å®Œå¤šæª¢æŸ¥", 
            "æª¢æŸ¥å®Œå†æª¢æŸ¥æˆ–è¶´ä¸‹ä¼‘æ¯",
            "è€ƒè©¦å³å°‡çµæŸï¼Œæª¢æŸ¥æœ‰æ²’æœ‰å¯«ç­”æ¡ˆæŠ„éŒ¯"
        ];
        
        const defaultBreakMsgs = [
            "ç­‰ç›£è€ƒè€å¸«é»å®Œå†é›¢é–‹åº§ä½ä¸‹èª²",
            "åˆ©ç”¨ä¸‹èª²æº–å‚™ä¸‹å€‹ç§‘ç›®èˆ‡æ–‡å…·ç”¨å“",
            "ææ—©ä¸Šå»æ‰€å–æ°´",
            "æ¡Œé¢æ·¨ç©º",
            "æº–å‚™è€ƒè©¦ã€æ”¶æ‹¾ä½ç½®ã€ååœ¨ä½ç½®ä¸Š"
        ];

        const defaultTimeSlots = [
            { start: "08:00", end: "08:50" },
            { start: "09:00", end: "09:40" },
            { start: "09:50", end: "10:30" }
        ];

        let timeSlots = JSON.parse(JSON.stringify(defaultTimeSlots));
        let currentMode = 'break'; 
        let currentMsgIndex = 0;
        let msgInterval;
        let extendedMinutes = 0;
        let currentSlotIndex = -1;

        window.onload = function() {
            document.getElementById('startupToast').style.display = 'block';
            loadSavedData();
            updateClock();
            setInterval(updateClock, 1000);
            checkStatusAndRotateMessages(true);
            window.addEventListener('resize', fitAllText);
            setTimeout(fitAllText, 500);
        };

        function closeStartupToast() {
            document.getElementById('startupToast').style.display = 'none';
        }

        function fitAllText() {
            const elements = document.querySelectorAll('.auto-fit');
            elements.forEach(el => fitText(el));
        }

        function fitText(el) {
            el.style.fontSize = ''; 
            if (el.tagName === 'SELECT' || el.tagName === 'TEXTAREA') return; 

            let fontSize = parseFloat(window.getComputedStyle(el).fontSize);
            while (el.scrollWidth > el.clientWidth && fontSize > 10) {
                fontSize -= 1;
                el.style.fontSize = fontSize + 'px';
            }
        }

        function saveInputs() {
            for(let i=0; i<3; i++) {
                localStorage.setItem(`subj-${i}`, document.getElementById(`subj-${i}`).value);
            }
            localStorage.setItem('expected', document.getElementById('inputExpected').value);
            localStorage.setItem('actual', document.getElementById('inputActual').value);
            localStorage.setItem('absent', document.getElementById('inputAbsent').value);
            fitAllText();
        }

        function adjustCount(id, delta) {
            const input = document.getElementById(id);
            let val = parseInt(input.value) || 0;
            val += delta;
            if(val < 0) val = 0;
            input.value = val;
            saveInputs();
        }

        function loadSavedData() {
            const savedSlots = localStorage.getItem('timeSlots');
            if (savedSlots) {
                timeSlots = JSON.parse(savedSlots);
            }
            updateScheduleDisplay();

            for(let i=0; i<3; i++) {
                const val = localStorage.getItem(`subj-${i}`);
                if(val) document.getElementById(`subj-${i}`).value = val;
            }
            if(localStorage.getItem('expected')) document.getElementById('inputExpected').value = localStorage.getItem('expected');
            if(localStorage.getItem('actual')) document.getElementById('inputActual').value = localStorage.getItem('actual');
            if(localStorage.getItem('absent')) document.getElementById('inputAbsent').value = localStorage.getItem('absent');

            if(!localStorage.getItem('examMsgs')) localStorage.setItem('examMsgs', JSON.stringify(defaultExamMsgs));
            if(!localStorage.getItem('breakMsgs')) localStorage.setItem('breakMsgs', JSON.stringify(defaultBreakMsgs));
        }

        function updateScheduleDisplay() {
            for (let i = 0; i < timeSlots.length; i++) {
                const el = document.getElementById(`time-display-${i}`);
                if (el) {
                    el.textContent = `${timeSlots[i].start} ~ ${timeSlots[i].end}`;
                }
            }
            fitAllText();
        }

        function openSettings() {
            const modal = document.getElementById('settingsModal');
            modal.style.display = 'flex';
            
            const container = document.getElementById('timeSettingsBlock');
            container.innerHTML = '';
            timeSlots.forEach((slot, index) => {
                const row = document.createElement('div');
                row.className = 'time-setting-row';
                row.innerHTML = `
                    <label>ç¬¬ ${index+1} ç¯€</label>
                    <input type="time" id="ts-start-${index}" value="${slot.start}">
                    <span>~</span>
                    <input type="time" id="ts-end-${index}" value="${slot.end}">
                `;
                container.appendChild(row);
            });

            document.getElementById('inputExamMsgs').value = (JSON.parse(localStorage.getItem('examMsgs')) || defaultExamMsgs).join('\n');
            document.getElementById('inputBreakMsgs').value = (JSON.parse(localStorage.getItem('breakMsgs')) || defaultBreakMsgs).join('\n');
        }

        function saveSettings() {
            const newSlots = [];
            for(let i=0; i<3; i++) {
                const start = document.getElementById(`ts-start-${i}`).value;
                const end = document.getElementById(`ts-end-${i}`).value;
                if(start && end) {
                    newSlots.push({start, end});
                } else {
                    newSlots.push(timeSlots[i]);
                }
            }
            timeSlots = newSlots;
            localStorage.setItem('timeSlots', JSON.stringify(timeSlots));
            updateScheduleDisplay();

            const examMsgs = document.getElementById('inputExamMsgs').value.split('\n').filter(line => line.trim() !== '');
            const breakMsgs = document.getElementById('inputBreakMsgs').value.split('\n').filter(line => line.trim() !== '');
            
            localStorage.setItem('examMsgs', JSON.stringify(examMsgs));
            localStorage.setItem('breakMsgs', JSON.stringify(breakMsgs));
            
            document.getElementById('settingsModal').style.display = 'none';
            checkStatusAndRotateMessages(true);
            updateClock();
        }

        function updateClock() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('zh-TW', { hour12: false });
            document.getElementById('clockDisplay').textContent = timeString;
            checkTimeStatus(now);
        }

        function checkTimeStatus(now) {
            let activeIndex = -1;
            let activeSlot = null;
            let isExamNow = false;
            
            // 1. æª¢æŸ¥æ˜¯å¦åœ¨è€ƒè©¦æ™‚é–“ (å„ªå…ˆ)
            for (let i = 0; i < timeSlots.length; i++) {
                const slot = timeSlots[i];
                const start = getDateFromTime(slot.start);
                const end = getDateFromTime(slot.end);
                
                let checkEnd = new Date(end);
                if (currentSlotIndex === i) {
                    checkEnd.setMinutes(checkEnd.getMinutes() + extendedMinutes);
                }

                if (now >= start && now <= checkEnd) {
                    activeIndex = i;
                    activeSlot = slot;
                    isExamNow = true;
                    break;
                }
            }

            if (isExamNow) {
                // é€²å…¥è€ƒè©¦æ¨¡å¼
                if (currentSlotIndex !== activeIndex || currentMode !== 'exam') {
                    currentSlotIndex = activeIndex;
                    currentMode = 'exam';
                    extendedMinutes = 0; 
                    checkStatusAndRotateMessages(true);
                }
                updateProgressBar(now, activeSlot, activeIndex);
            } else {
                // 2. æª¢æŸ¥æ˜¯å¦åœ¨å…©ç¯€è€ƒè©¦ä¸­é–“ (ä¸‹èª²å€’æ•¸)
                let isBreakGap = false;
                let nextSubjIndex = -1;
                let gapStart = null;
                let gapEnd = null;

                for (let i = 0; i < timeSlots.length - 1; i++) {
                    const currentEnd = getDateFromTime(timeSlots[i].end); // è¡¨å®šçµæŸæ™‚é–“
                    const nextStart = getDateFromTime(timeSlots[i+1].start); // è¡¨å®šé–‹å§‹æ™‚é–“
                    
                    if (now >= currentEnd && now < nextStart) {
                        isBreakGap = true;
                        nextSubjIndex = i + 1;
                        gapStart = currentEnd;
                        gapEnd = nextStart;
                        break;
                    }
                }

                if (isBreakGap) {
                    // ä¸‹èª²å€’æ•¸æ¨¡å¼
                    if (currentMode !== 'break') {
                        currentMode = 'break';
                        currentSlotIndex = -1;
                        extendedMinutes = 0;
                        checkStatusAndRotateMessages(true);
                    }
                    updateBreakProgressBar(now, gapStart, gapEnd, nextSubjIndex);
                } else {
                    // å®Œå…¨é–’ç½® (æ—©ä¸Šã€æ”¾å­¸ã€éè€ƒè©¦éä¸‹èª²æ™‚æ®µ)
                    if (currentMode !== 'break') {
                        currentMode = 'break';
                        currentSlotIndex = -1;
                        extendedMinutes = 0;
                        checkStatusAndRotateMessages(true);
                    }
                    resetProgressBar();
                }
            }

            // Aå€é«˜äº®
            const rows = document.querySelectorAll('.schedule-row');
            rows.forEach((row, i) => {
                if (i === currentSlotIndex && isExamNow) {
                    row.classList.add('active');
                } else {
                    row.classList.remove('active');
                }
            });
        }

        function getDateFromTime(timeStr) {
            const now = new Date();
            const [h, m] = timeStr.split(':');
            now.setHours(h, m, 0, 0);
            return now;
        }

        function updateProgressBar(now, slot, index) {
            const start = getDateFromTime(slot.start);
            const end = getDateFromTime(slot.end);
            end.setMinutes(end.getMinutes() + extendedMinutes);

            const totalDuration = end - start;
            const elapsed = now - start;
            const remaining = end - now;
            
            const percent = Math.min(100, Math.max(0, (elapsed / totalDuration) * 100));
            const remainingMins = Math.ceil(remaining / 1000 / 60);

            const statusBadge = document.getElementById('statusBadge');
            const progressBar = document.getElementById('progressBar');
            const extendBtn = document.getElementById('extendBtn');
            const subjName = document.getElementById(`subj-${index}`).value;

            statusBadge.textContent = "è€ƒè©¦ä¸­";
            statusBadge.className = "status-badge status-exam";
            extendBtn.style.display = "block";

            progressBar.style.width = `${percent}%`;
            
            let timeText = `ç§‘ç›®ï¼š${subjName} | å‰©é¤˜æ™‚é–“ï¼š${remainingMins} åˆ†é˜`;
            if (extendedMinutes > 0) timeText += ` (å»¶é•· ${extendedMinutes} åˆ†)`;
            document.getElementById('progressText').textContent = timeText;

            if (remaining <= 10 * 60 * 1000) {
                progressBar.style.backgroundColor = 'var(--progress-red)';
            } else if (percent >= 50) {
                progressBar.style.backgroundColor = 'var(--progress-yellow)';
            } else {
                progressBar.style.backgroundColor = 'var(--progress-green)';
            }
            fitAllText(); // ç¢ºä¿æ–‡å­—ç¸®æ”¾
        }

        function updateBreakProgressBar(now, start, end, nextIndex) {
            const statusBadge = document.getElementById('statusBadge');
            const progressBar = document.getElementById('progressBar');
            const extendBtn = document.getElementById('extendBtn');
            const nextSubjName = document.getElementById(`subj-${nextIndex}`).value;

            const totalDuration = end - start;
            const elapsed = now - start;
            const remaining = end - now;
            
            // é€²åº¦æ¢åå‘ (å€’æ•¸æ„Ÿ) æˆ–æ˜¯æ­£å‘ (åº¦éä¸‹èª²æ™‚é–“) é€™è£¡æ¡ç”¨æ­£å‘å¡«æ»¿
            const percent = Math.min(100, Math.max(0, (elapsed / totalDuration) * 100));
            const remainingMins = Math.ceil(remaining / 1000 / 60);

            statusBadge.textContent = "ä¸‹èª²ä¼‘æ¯";
            statusBadge.className = "status-badge status-break";
            extendBtn.style.display = "none";

            progressBar.style.width = `${percent}%`;
            progressBar.style.backgroundColor = 'var(--progress-green)'; // ä¿æŒç¶ è‰²ä»£è¡¨ä¼‘æ¯

            document.getElementById('progressText').textContent = `ä¸‹ç¯€ç§‘ç›®ï¼š${nextSubjName} | è·é›¢é–‹å§‹ï¼š${remainingMins} åˆ†é˜`;
            fitAllText();
        }

        function resetProgressBar() {
            const statusBadge = document.getElementById('statusBadge');
            const progressBar = document.getElementById('progressBar');
            const extendBtn = document.getElementById('extendBtn');

            statusBadge.textContent = "æº–å‚™ä¸­ / å·²çµæŸ";
            statusBadge.className = "status-badge status-break";
            extendBtn.style.display = "none";
            progressBar.style.width = "0%";
            progressBar.style.backgroundColor = 'var(--progress-green)';
            document.getElementById('progressText').textContent = "éè€ƒè©¦æ™‚æ®µ";
            fitAllText();
        }

        function extendTime() {
            if (currentMode === 'exam') {
                extendedMinutes += 5;
                updateClock(); 
            }
        }

        function checkStatusAndRotateMessages(forceReset = false) {
            if (msgInterval) clearInterval(msgInterval);
            
            let messages = [];
            let intervalTime = 0;

            if (currentMode === 'exam') {
                messages = JSON.parse(localStorage.getItem('examMsgs')) || defaultExamMsgs;
                intervalTime = 5 * 60 * 1000;
            } else {
                messages = JSON.parse(localStorage.getItem('breakMsgs')) || defaultBreakMsgs;
                intervalTime = 2 * 60 * 1000;
            }

            if (forceReset) currentMsgIndex = 0;
            showNextMessage(messages);

            msgInterval = setInterval(() => {
                currentMsgIndex++;
                showNextMessage(messages);
            }, intervalTime);
        }

        function showNextMessage(messages) {
            if (!messages || messages.length === 0) return;
            const index = currentMsgIndex % messages.length;
            const text = messages[index];
            
            const display = document.getElementById('reminderDisplay');
            display.style.opacity = 0;
            setTimeout(() => {
                display.textContent = text;
                display.style.opacity = 1;
            }, 500);
        }

        document.addEventListener('keydown', function(event) {
            if (event.key === "Escape") {
                document.getElementById('settingsModal').style.display = 'none';
            }
        });

    </script>
</body>
</html>
