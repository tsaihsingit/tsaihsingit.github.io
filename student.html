<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç­ç´šå­¸ç”Ÿè¨ˆåˆ†æ¿</title>
    <style>
        :root {
            --bg-color: #222;
            --card-bg: #333;
            --text-color: #eee;
            --accent-color: #4CAF50;
            --danger-color: #f44336;
            --col-count: 7;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: "Microsoft JhengHei", "Heiti TC", sans-serif;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* é ‚éƒ¨å·¥å…·åˆ— */
        .header {
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            max-width: 1200px;
        }

        h1 { margin: 0; font-size: 1.5rem; }

        button {
            cursor: pointer;
            border: none;
            border-radius: 4px;
            padding: 8px 16px;
            font-size: 1rem;
            transition: 0.2s;
            font-family: inherit;
        }

        .btn-settings { background-color: #555; color: white; }
        .btn-settings:hover { background-color: #777; }

        /* ç¶²æ ¼ä½ˆå±€ */
        #grid-container {
            display: grid;
            grid-template-columns: repeat(var(--col-count), 1fr);
            gap: 12px;
            width: 100%;
            max-width: 100%;
        }

        /* å­¸ç”Ÿå¡ç‰‡ */
        .student-card {
            background-color: var(--card-bg);
            border-radius: 8px;
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            position: relative;
            min-height: 140px;
            transition: transform 0.1s;
        }

        .student-card:hover {
            transform: translateY(-2px);
            background-color: #3a3a3a;
        }

        /* å­¸ç”Ÿè³‡è¨Šæ¨™é ­ (åº§è™Ÿ + å§“å) */
        .student-header {
            position: absolute;
            top: 5px;
            left: 8px;
            right: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .seat-num {
            font-size: 0.9rem;
            color: #888;
            font-weight: bold;
            flex-shrink: 0;
            user-select: none;
        }

        .student-name {
            font-size: 0.9rem;
            color: #ccc;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-weight: normal;
        }

        .icon-display {
            font-size: 3rem;
            margin: 15px 0 10px 0;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            user-select: none;
        }

        /* åˆ†æ•¸èˆ‡æŒ‰éˆ•åŒä¸€è¡Œ */
        .score-row {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            gap: 8px;
        }

        .score-display {
            font-size: 1.8rem;
            font-weight: bold;
            color: #fff;
            min-width: 40px;
            text-align: center;
            line-height: 1;
        }

        .btn-score {
            width: 36px;
            height: 36px;
            font-size: 1.4rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            padding: 0;
            line-height: 1;
            flex-shrink: 0;
        }

        .btn-minus { background-color: var(--danger-color); }
        .btn-plus { background-color: var(--accent-color); }
        .btn-minus:active { background-color: #d32f2f; transform: scale(0.95); }
        .btn-plus:active { background-color: #388E3C; transform: scale(0.95); }

        /* è¨­å®šè¦–çª— Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.7);
            z-index: 100;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(2px);
        }

        .modal-content {
            background-color: #2a2a2a;
            padding: 24px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            border: 1px solid #444;
            max-height: 90vh; /* é˜²æ­¢å¤ªé«˜è¶…å‡ºè¢å¹• */
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            font-size: 1.4rem;
            margin-bottom: 20px;
            border-bottom: 1px solid #444;
            padding-bottom: 15px;
            color: white;
            font-weight: bold;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #ccc;
            font-size: 0.95rem;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            background: #333;
            border: 1px solid #555;
            color: white;
            border-radius: 6px;
            box-sizing: border-box;
            font-size: 1rem;
        }
        
        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        /* åŒ¯å‡ºå€åŸŸæ¨£å¼ */
        .export-section {
            border-top: 1px solid #444;
            padding-top: 20px;
            margin-top: 10px;
        }
        
        textarea {
            width: 100%;
            background: #1a1a1a;
            border: 1px solid #555;
            color: #ddd;
            padding: 10px;
            border-radius: 6px;
            resize: vertical;
            font-family: monospace;
            box-sizing: border-box;
            font-size: 0.9rem;
            white-space: pre;
            min-height: 100px;
        }

        textarea:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            margin-top: 30px;
            align-items: center;
        }

        .btn-save { background-color: var(--accent-color); color: white; font-weight: bold;}
        .btn-cancel { background-color: transparent; color: #aaa; border: 1px solid #555; }
        .btn-reset { background-color: #d32f2f; color: white; margin-right: auto; }
        .btn-reset.confirm-state { background-color: #b71c1c; content: "ç¢ºå®š?"; }

        /* é€šçŸ¥è¨Šæ¯ Toast */
        .toast {
            visibility: hidden;
            min-width: 250px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 4px;
            padding: 16px;
            position: fixed;
            z-index: 200;
            left: 50%;
            bottom: 30px;
            transform: translateX(-50%);
            border: 1px solid #555;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            opacity: 0;
            transition: opacity 0.3s, bottom 0.3s;
        }

        .toast.show {
            visibility: visible;
            opacity: 1;
            bottom: 50px;
        }

        /* RWD èª¿æ•´ */
        @media (max-width: 768px) {
            #grid-container {
                grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            }
            .icon-display { font-size: 2.5rem; }
            .modal-content { width: 95%; padding: 20px; }
            .btn-score { width: 44px; height: 44px; }
        }
    </style>
</head>
<body>

    <div class="header">
        <h1>ğŸ† ç­ç´šè¨ˆåˆ†æ¿</h1>
        <button class="btn-settings" onclick="openSettings()">âš™ï¸ è¨­å®š</button>
    </div>

    <div id="grid-container">
        <!-- Javascript å°‡åœ¨æ­¤ç”¢ç”Ÿå…§å®¹ -->
    </div>

    <!-- è¨­å®š Modal -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">è¨­å®šé¸é …</div>
            
            <div class="form-group">
                <label>å­¸ç”Ÿç¸½æ•¸ (é è¨­: 6x7=42)</label>
                <input type="number" id="setting-total" min="1" max="100">
            </div>

            <div class="form-group">
                <label>æ¯è¡Œæ¬„æ•¸ (Columns, æ¡Œé¢ç‰ˆç”Ÿæ•ˆ)</label>
                <input type="number" id="setting-cols" min="1" max="12">
            </div>

            <div class="form-group">
                <label>åœ–ç¤ºä¸»é¡Œ</label>
                <select id="setting-theme">
                    <option value="0">å»ºç¯‰ (ğŸ• ğŸ  ğŸ¡ ğŸ¢ ğŸ°)</option>
                    <option value="1">è²¡å¯Œ (ğŸ’² ğŸ’¸ ğŸ’µ ğŸ’° ğŸ’)</option>
                    <option value="2">äº¤é€š (ğŸ›´ ğŸš™ ğŸš‚ ğŸ›© ğŸš€)</option>
                </select>
            </div>

            <div class="form-group">
                <label>åœ–ç¤ºå‡ç´šé–€æª» (æ¯å¤šå°‘åˆ†)</label>
                <select id="setting-threshold">
                    <option value="5">æ¯ 5 åˆ†</option>
                    <option value="10">æ¯ 10 åˆ†</option>
                </select>
            </div>

            <div class="form-group">
                <label>ç·¨è¼¯å§“å (æ ¼å¼ï¼šåº§è™Ÿ [TAB] å§“åï¼Œæ¯è¡Œä¸€ä½)</label>
                <textarea id="name-editor-area" rows="6" placeholder="1	ç‹å°æ˜&#10;2	æå°è¯"></textarea>
            </div>

            <!-- åŒ¯å‡ºå€åŸŸ -->
            <div class="form-group export-section">
                <label>åŒ¯å‡ºè³‡æ–™ (åº§è™Ÿ [TAB] å§“å [TAB] åˆ†æ•¸)</label>
                <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                    <button class="btn-settings" onclick="exportScores()" style="flex: 1;">ğŸ“‹ ç”¢ç”Ÿè³‡æ–™</button>
                    <button class="btn-settings" onclick="copyExport()" style="flex: 1;">è¤‡è£½å…§å®¹</button>
                </div>
                <textarea id="export-area" rows="4" readonly placeholder="é»æ“Šã€Œç”¢ç”Ÿè³‡æ–™ã€æŒ‰éˆ•..."></textarea>
            </div>

            <div class="modal-footer">
                <button id="btn-reset" class="btn-reset" onclick="handleReset()">é‡ç½®æ‰€æœ‰è³‡æ–™</button>
                <button class="btn-cancel" onclick="closeSettings()">å–æ¶ˆ</button>
                <button class="btn-save" onclick="saveSettings()">å„²å­˜è®Šæ›´</button>
            </div>
        </div>
    </div>

    <div id="toast" class="toast">è¨­å®šå·²å„²å­˜</div>

    <script>
        // --- è¨­å®šèˆ‡å¸¸æ•¸ ---
        const DEFAULT_CONFIG = {
            totalStudents: 42,
            columns: 7,
            iconSetIndex: 0, // 0: Building, 1: Money, 2: Transport
            threshold: 5     // 5 or 10
        };

        const ICON_SETS = [
            ['ğŸ•', 'ğŸ ', 'ğŸ¡', 'ğŸ¢', 'ğŸ°'],
            ['ğŸ’²', 'ğŸ’¸', 'ğŸ’µ', 'ğŸ’°', 'ğŸ’'],
            ['ğŸ›´', 'ğŸš™', 'ğŸš‚', 'ğŸ›©', 'ğŸš€']
        ];

        // æ‡‰ç”¨ç¨‹å¼ç‹€æ…‹
        let appState = {
            config: { ...DEFAULT_CONFIG },
            students: [] // Array of { id: 1, score: 0, name: '' }
        };

        let resetConfirmStage = false; // ç”¨æ–¼é‡ç½®æŒ‰éˆ•çš„é›™é‡ç¢ºèª

        // --- å„²å­˜æ©Ÿåˆ¶ (LocalStorage & Cookie) ---
        
        function saveToStorage() {
            const dataStr = JSON.stringify(appState);
            
            // 1. Save to LocalStorage
            try {
                localStorage.setItem('classScoreboardData', dataStr);
            } catch (e) {
                console.warn('LocalStorage not available');
            }

            // 2. Save to Cookie (è¨­å®šéæœŸæ™‚é–“ç‚º 1 å¹´)
            const d = new Date();
            d.setTime(d.getTime() + (365*24*60*60*1000));
            let expires = "expires="+ d.toUTCString();
            // ç°¡å–®ç·¨ç¢¼
            document.cookie = "classScoreboardData=" + encodeURIComponent(dataStr) + ";" + expires + ";path=/;SameSite=Strict";
        }

        function loadFromStorage() {
            // 1. Try LocalStorage
            try {
                const lsData = localStorage.getItem('classScoreboardData');
                if (lsData) {
                    appState = JSON.parse(lsData);
                    // ç°¡å–®çš„è³‡æ–™å®Œæ•´æ€§æª¢æŸ¥
                    if (!appState.students || !appState.config) throw new Error("Invalid Data");
                    return true;
                }
            } catch(e) { console.error("LS Parse Error or Empty", e); }

            // 2. Try Cookie if LS failed
            const name = "classScoreboardData=";
            try {
                const decodedCookie = decodeURIComponent(document.cookie);
                const ca = decodedCookie.split(';');
                for(let i = 0; i < ca.length; i++) {
                    let c = ca[i];
                    while (c.charAt(0) == ' ') {
                        c = c.substring(1);
                    }
                    if (c.indexOf(name) == 0) {
                        appState = JSON.parse(c.substring(name.length, c.length));
                        return true;
                    }
                }
            } catch(e) { console.error("Cookie Parse Error", e); }
            
            return false;
        }

        // --- é‚è¼¯æ ¸å¿ƒ ---

        function initData() {
            // å¦‚æœæ²’æœ‰è¼‰å…¥åˆ°è³‡æ–™ï¼Œå‰‡åˆå§‹åŒ–
            if (!loadFromStorage()) {
                initializeStudents(DEFAULT_CONFIG.totalStudents);
            } else {
                // è³‡æ–™é·ç§»æª¢æŸ¥ï¼šç¢ºä¿æ‰€æœ‰å­¸ç”Ÿéƒ½æœ‰ name å±¬æ€§
                let modified = false;
                appState.students.forEach(s => {
                    if (s.name === undefined) {
                        s.name = "";
                        modified = true;
                    }
                });
                if (modified) saveToStorage();
            }
            renderGrid();
        }

        function initializeStudents(count) {
            // ä¿ç•™èˆŠçš„åˆ†æ•¸ï¼Œå¦‚æœæ•¸é‡è®Šå°‘å‰‡æˆªæ–·ï¼Œè®Šå¤šå‰‡æ–°å¢
            let newStudents = [];
            for (let i = 1; i <= count; i++) {
                // å˜—è©¦å¾ç¾æœ‰ç‹€æ…‹æ‰¾èˆŠè³‡æ–™
                let existing = appState.students.find(s => s.id === i);
                if (existing) {
                    if (existing.name === undefined) existing.name = ""; // é˜²å‘†
                    newStudents.push(existing);
                } else {
                    newStudents.push({ id: i, score: 0, name: "" });
                }
            }
            appState.students = newStudents;
        }

        function getIcon(score) {
            const set = ICON_SETS[appState.config.iconSetIndex];
            const threshold = parseInt(appState.config.threshold);
            
            // è¨ˆç®—ç­‰ç´šï¼šåˆ†æ•¸é™¤ä»¥é–€æª»ï¼Œç„¡æ¢ä»¶æ¨å»
            let level = Math.floor(score / threshold);
            
            // é‚Šç•Œæª¢æŸ¥ï¼šæœ€å°ç‚º0ï¼Œæœ€å¤§ç‚ºåœ–ç¤ºæ•¸é‡-1
            if (level < 0) level = 0;
            if (level >= set.length) level = set.length - 1;
            
            return set[level];
        }

        function updateScore(id, delta) {
            const student = appState.students.find(s => s.id === id);
            if (student) {
                student.score += delta;
                saveToStorage();
                updateCardView(student); // åªæ›´æ–°å–®ä¸€å¡ç‰‡ä»¥æå‡æ•ˆèƒ½
            }
        }

        // --- ç•«é¢æ¸²æŸ“ ---

        function renderGrid() {
            const container = document.getElementById('grid-container');
            container.innerHTML = '';
            
            // è¨­å®š CSS Grid Columns
            document.documentElement.style.setProperty('--col-count', appState.config.columns);

            appState.students.forEach(student => {
                const card = document.createElement('div');
                card.className = 'student-card';
                card.id = `card-${student.id}`;
                
                // é¡¯ç¤ºï¼šåº§è™Ÿ + å§“å (éè¼¸å…¥æ¡†)
                card.innerHTML = `
                    <div class="student-header">
                        <div class="seat-num">${student.id}</div>
                        <div class="student-name">${student.name || ''}</div>
                    </div>
                    <div class="icon-display" id="icon-${student.id}">${getIcon(student.score)}</div>
                    <div class="score-row">
                        <button class="btn-score btn-minus" onclick="updateScore(${student.id}, -1)">-</button>
                        <div class="score-display" id="score-${student.id}">${student.score}</div>
                        <button class="btn-score btn-plus" onclick="updateScore(${student.id}, 1)">+</button>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function updateCardView(student) {
            const scoreEl = document.getElementById(`score-${student.id}`);
            const iconEl = document.getElementById(`icon-${student.id}`);
            if (scoreEl && iconEl) {
                scoreEl.textContent = student.score;
                iconEl.textContent = getIcon(student.score);
                
                // ç°¡å–®çš„å‹•ç•«æ•ˆæœ
                iconEl.animate([
                    { transform: 'scale(1)' },
                    { transform: 'scale(1.2)' },
                    { transform: 'scale(1)' }
                ], { duration: 200 });
            }
        }

        // --- è¨­å®šä»‹é¢é‚è¼¯ ---

        function openSettings() {
            document.getElementById('setting-total').value = appState.config.totalStudents;
            document.getElementById('setting-cols').value = appState.config.columns;
            document.getElementById('setting-theme').value = appState.config.iconSetIndex;
            document.getElementById('setting-threshold').value = appState.config.threshold;
            
            // å¡«å……å§“åç·¨è¼¯å€
            const nameData = appState.students
                .map(s => `${s.id}\t${s.name}`)
                .join('\n');
            document.getElementById('name-editor-area').value = nameData;

            // æ¸…ç©ºåŒ¯å‡ºå€åŸŸï¼Œé¿å…é¡¯ç¤ºèˆŠè³‡æ–™
            document.getElementById('export-area').value = '';

            // Reset reset button state
            resetConfirmStage = false;
            const btn = document.getElementById('btn-reset');
            btn.innerText = "é‡ç½®æ‰€æœ‰è³‡æ–™";
            btn.classList.remove('confirm-state');

            document.getElementById('settingsModal').style.display = 'flex';
        }

        function closeSettings() {
            document.getElementById('settingsModal').style.display = 'none';
        }

        function saveSettings() {
            const newTotal = parseInt(document.getElementById('setting-total').value);
            const newCols = parseInt(document.getElementById('setting-cols').value);
            const newTheme = parseInt(document.getElementById('setting-theme').value);
            const newThreshold = parseInt(document.getElementById('setting-threshold').value);

            if (newTotal < 1 || newCols < 1) {
                showToast("æ•¸å€¼å¿…é ˆå¤§æ–¼ 0");
                return;
            }

            // æ›´æ–°è¨­å®š
            appState.config.totalStudents = newTotal;
            appState.config.columns = newCols;
            appState.config.iconSetIndex = newTheme;
            appState.config.threshold = newThreshold;

            // é‡æ–°åˆå§‹åŒ–é™£åˆ— (å¢æ¸›å­¸ç”Ÿæ•¸é‡)
            initializeStudents(newTotal);

            // è™•ç†å§“åæ‰¹æ¬¡æ›´æ–°
            const nameEditorContent = document.getElementById('name-editor-area').value;
            const lines = nameEditorContent.split('\n');
            
            // å»ºç«‹ä¸€å€‹æš«æ™‚çš„ Map ä¾†å„²å­˜è¼¸å…¥çš„å§“åï¼Œæ–¹ä¾¿æŸ¥æ‰¾
            const nameMap = new Map();
            lines.forEach(line => {
                const parts = line.split('\t'); // ä½¿ç”¨ TAB åˆ†éš”
                // å¦‚æœæ²’æœ‰ TABï¼Œå˜—è©¦ç”¨ç©ºæ ¼ (å¯¬å®¹æ¨¡å¼)
                const id = parseInt(parts[0]);
                let name = "";
                
                if (parts.length > 1) {
                    name = parts[1].trim();
                } else {
                    // å˜—è©¦ç”¨ç©ºæ ¼è§£æï¼š "1 ç‹å°æ˜"
                    const spaceParts = line.trim().split(/\s+/);
                    if (spaceParts.length >= 2) {
                         const potentialId = parseInt(spaceParts[0]);
                         if (!isNaN(potentialId)) {
                             // å‰©ä¸‹çš„éƒ¨åˆ†çµ„åˆå›åå­—
                             name = spaceParts.slice(1).join(' ');
                         }
                    }
                }

                if (!isNaN(id)) {
                    nameMap.set(id, name);
                }
            });

            // æ›´æ–° appState ä¸­çš„å§“å
            appState.students.forEach(student => {
                if (nameMap.has(student.id)) {
                    student.name = nameMap.get(student.id);
                }
            });
            
            saveToStorage();
            renderGrid(); // å…¨éƒ¨é‡ç¹ªä»¥å¥—ç”¨æ–°è¨­å®š
            closeSettings();
            showToast("è¨­å®šå·²å„²å­˜ï¼");
        }

        // --- åŒ¯å‡ºåŠŸèƒ½ ---
        function exportScores() {
            const exportText = appState.students
                .map(s => `${s.id}\t${s.name}\t${s.score}`)
                .join('\n');
            const area = document.getElementById('export-area');
            area.value = exportText;
            area.select(); // æç¤ºä½¿ç”¨è€…è³‡æ–™å·²é¸å–
        }

        function copyExport() {
            const area = document.getElementById('export-area');
            if (!area.value) {
                showToast("è«‹å…ˆé»æ“Šã€Œç”¢ç”Ÿè³‡æ–™ã€");
                return;
            }
            area.select();
            document.execCommand('copy');
            showToast("å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿");
        }

        // --- é‡ç½®åŠŸèƒ½ ---

        function handleReset() {
            const btn = document.getElementById('btn-reset');
            
            if (!resetConfirmStage) {
                // ç¬¬ä¸€éšæ®µï¼šè«‹æ±‚ç¢ºèª
                resetConfirmStage = true;
                btn.innerText = "ç¢ºå®šè¦åˆªé™¤å—ï¼Ÿ(å†æ¬¡é»æ“Š)";
                btn.classList.add('confirm-state');
            } else {
                // ç¬¬äºŒéšæ®µï¼šåŸ·è¡Œé‡ç½®
                performReset();
            }
        }

        function performReset() {
            localStorage.removeItem('classScoreboardData');
            document.cookie = "classScoreboardData=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
            appState.config = { ...DEFAULT_CONFIG };
            appState.students = [];
            initializeStudents(DEFAULT_CONFIG.totalStudents);
            saveToStorage();
            renderGrid();
            closeSettings();
            showToast("æ‰€æœ‰è³‡æ–™å·²é‡ç½®");
        }

        function showToast(msg) {
            const toast = document.getElementById("toast");
            toast.innerText = msg;
            toast.className = "toast show";
            setTimeout(function(){ toast.className = toast.className.replace("show", ""); }, 3000);
        }

        // é»æ“Š Modal å¤–éƒ¨é—œé–‰
        window.onclick = function(event) {
            const modal = document.getElementById('settingsModal');
            if (event.target == modal) {
                closeSettings();
            }
        }

        // --- å•Ÿå‹• ---
        initData();

    </script>
</body>
</html>